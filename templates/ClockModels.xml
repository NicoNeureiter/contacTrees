
<beast version='2.0'
       namespace='beast.app.beauti:beast.core:beast.evolution.branchratemodel:beast.evolution.speciation:beast.evolution.tree.coalescent:beast.core.util:beast.evolution.nuc:beast.evolution.operators:beast.evolution.sitemodel:beast.evolution.substitutionmodel:beast.evolution.likelihood:beast.evolution:beast.math.distributions'>


    <!-- Clock models -->
    <mergewith point='contacTreesClockModelTemplates'>

        <!-- Strict clock -->
        <subtemplate id='StrictClock' class='beast.evolution.branchratemodel.StrictClockModel'
                     mainid='StrictClock.c:Species'>
            <![CDATA[
                <branchRateModel spec='StrictClockModel' id='StrictClock.c:Species'>
                    <clock.rate id='clockRate.c:Species' spec='parameter.RealParameter' value='1.0' estimate='false'/>
                </branchRateModel>

				<operator id='StrictClockRateScaler.c:Species' spec='ScaleOperator' scaleFactor="0.75" weight="3" parameter='@clockRate.c:Species'/>

                <upDownOperator id='strictClockUpDownOperator.c:Species' spec='UpDownOperator' scaleFactor="0.75" weight="3">
                    <up idref="clockRate.c:Species"/>
                    <down idref="Tree.t:Species"/>
                </upDownOperator>
                
		        <prior id='ClockPrior.c:Species' x='@clockRate.c:Species'><distr spec="beast.math.distributions.Uniform" upper='Infinity'/></prior>
]]>
            <connect srcID='clockRate.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(clockRate.c:Species) and clockRate.c:Species/estimate=true'/>

            <connect srcID='clockRate.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(clockRate.c:Species) and clockRate.c:Species/estimate=true'/>
            <connect srcID='ClockPrior.c:Species' targetID='prior' inputName='distribution'
                     if='inlikelihood(clockRate.c:Species) and clockRate.c:Species/estimate=true'>substitution rate of
                partition c:Species
            </connect>
            <connect srcID='StrictClockRateScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(clockRate.c:Species) and clockRate.c:Species/estimate=true'>Scale substitution rate of
                partition c:Species
            </connect>
            <connect srcID='strictClockUpDownOperator.c:Species' targetID='mcmc' inputName='operator'
                     if='nooperator(FixMeanRatesOperator) and inlikelihood(clockRate.c:Species) and inlikelihood(Tree.t:Species) and Tree.t:Species/estimate=true and clockRate.c:Species/estimate=true'>
                Scale up substitution rate c:Species and scale down tree t:Species
            </connect>
        </subtemplate>

        <!-- Relaxed clock exponential -->
        <subtemplate id='RelaxedClockExponential' class='beast.evolution.branchratemodel.UCRelaxedClockModel'
                     mainid='ExponentialRelaxedClock.c:Species'
                     suppressInputs='beast.evolution.branchratemodel.UCRelaxedClockModel.distr,beast.evolution.branchratemodel.UCRelaxedClockModel.rateQuantiles,beast.evolution.branchratemodel.UCRelaxedClockModel.rates'>
            <![CDATA[
        <plugin spec='UCRelaxedClockModel' id="ExponentialRelaxedClock.c:Species" tree='@Tree.t:Species'>
			<parameter name='clock.rate' id='ucedMean.c:Species' value='1.0' estimate='false'/>
            <distr id='Exponential.c:Species' name='distr' spec="beast.math.distributions.Exponential">
				<parameter id='UCExpLambda.c:Species' name='mean' value='1.0'/>
			</distr>
            <rateCategories spec='parameter.IntegerParameter' id='expRateCategories.c:Species' value="1" dimension='10' estimate='true'/>
        </plugin>

        <operator id='ucedMeanScaler.c:Species' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="1" parameter="@ucedMean.c:Species"/>
        <operator id="ExpCategoriesRandomWalk.c:Species" spec="IntRandomWalkOperator" windowSize='1' weight="10" parameter="@expRateCategories.c:Species"/>
		<operator id='ExpCategoriesSwapOperator.c:Species' spec='SwapOperator' howMany="1" weight="10" intparameter='@expRateCategories.c:Species'/>
		<operator id='ExpCategoriesUniform.c:Species' spec='UniformOperator' weight="10" parameter='@expRateCategories.c:Species'/>

		<upDownOperator id='relaxedUpDownOperatorExp.c:Species' spec='UpDownOperator' scaleFactor="0.75" weight="3">
			<up idref="ucedMean.c:Species"/>
			<down idref="Tree.t:Species"/>
		</upDownOperator>

		<log id='rateStat.c:Species' spec='RateStatistic' tree='@Tree.t:Species' branchratemodel='@ExponentialRelaxedClock.c:Species'/>
        <prior id='UCMeanRatePrior.c:Species' x='@ucedMean.c:Species'><distr spec="beast.math.distributions.Uniform" upper='Infinity'/></prior>
]]>
            <connect srcID='ucedMean.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(ucedMean.c:Species) and ucedMean.c:Species/estimate=true'/>
            <connect srcID='expRateCategories.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(expRateCategories.c:Species)'/>

            <connect srcID='UCMeanRatePrior.c:Species' targetID='prior' inputName='distribution'
                     if='inlikelihood(ucedMean.c:Species) and ucedMean.c:Species/estimate=true'>uncorrelated exponential
                relaxed clock mean of partition c:Species
            </connect>

            <connect srcID='ucedMeanScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(ucedMean.c:Species) and ucedMean.c:Species/estimate=true'>Scale clock rate of partition
                c:Species
            </connect>
            <connect srcID='ExpCategoriesRandomWalk.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(expRateCategories.c:Species) and expRateCategories.c:Species/estimate=true'>Randomly change categories of partition c:Species
            </connect>
            <connect srcID='ExpCategoriesSwapOperator.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(expRateCategories.c:Species) and expRateCategories.c:Species/estimate=true'>Swap categories of partition c:Species
            </connect>
            <connect srcID='ExpCategoriesUniform.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(expRateCategories.c:Species) and expRateCategories.c:Species/estimate=true'>Uniformly draw categories of partition c:Species
            </connect>
            <connect srcID='relaxedUpDownOperatorExp.c:Species' targetID='mcmc' inputName='operator'
                     if='nooperator(FixMeanRatesOperator) and inlikelihood(ucedMean.c:Species) and inlikelihood(Tree.t:Species) and ucedMean.c:Species/estimate=true and Tree.t:Species/estimate=true'>
                Up/down scaler for mean rate and tree of partition c:Species
            </connect>
            <connect srcID='Tree.t:Species' targetID='ExponentialRelaxedClock.c:Species' inputName='tree' if='inlikelihood(ExponentialRelaxedClock.c:Species)'/>
            <connect srcID='Tree.t:Species' targetID='rateStat.c:Species' inputName='tree' if='inlikelihood(ExponentialRelaxedClock.c:Species)'/>

            <connect srcID='ucedMean.c:Species' targetID='tracelog' inputName='log'
                     if='inlikelihood(ucedMean.c:Species) and ucedMean.c:Species/estimate=true'/>
            <connect srcID='rateStat.c:Species' targetID='tracelog' inputName='log'
                     if='inposterior(ExponentialRelaxedClock.c:Species)'/>

            <connect srcID='ExponentialRelaxedClock.c:Species' targetID='TreeWithMetaDataLogger.t:Species'
                     inputName='branchratemodel' if='inposterior(ExponentialRelaxedClock.c:Species)'/>
        </subtemplate>


        <!-- Relaxed clock log normal -->
        <subtemplate id='RelaxedClockLogNormal' class='beast.evolution.branchratemodel.UCRelaxedClockModel'
                     mainid='RelaxedClock.c:Species'
                     suppressInputs='beast.evolution.branchratemodel.UCRelaxedClockModel.distr,beast.evolution.branchratemodel.UCRelaxedClockModel.rateQuantiles,beast.evolution.branchratemodel.UCRelaxedClockModel.rates'>
            <![CDATA[
        <plugin spec='UCRelaxedClockModel' id="RelaxedClock.c:Species" tree='@Tree.t:Species'>
			<parameter name='clock.rate' id='ucldMean.c:Species' value='1.0'/>
            <distr id='LogNormalDistributionModel.c:Species' name='distr' spec="beast.math.distributions.LogNormalDistributionModel" meanInRealSpace='true'>
                <parameter name='M' value="1.0" estimate='false' lower='0' upper='1'/>
                <parameter name='S' id='ucldStdev.c:Species' value="0.1" lower="0" estimate='true'/>
            </distr>
            <rateCategories spec='parameter.IntegerParameter' id='rateCategories.c:Species' value="1" dimension='10' estimate='true'/>
        </plugin>

        <operator id='ucldMeanScaler.c:Species' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="1" parameter="@ucldMean.c:Species"/>
        <operator id='ucldStdevScaler.c:Species' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="3" parameter="@ucldStdev.c:Species"/>
        <operator id="CategoriesRandomWalk.c:Species" spec="IntRandomWalkOperator" windowSize='1' weight="10" parameter="@rateCategories.c:Species"/>
		<operator id='CategoriesSwapOperator.c:Species' spec='SwapOperator' howMany="1" weight="10" intparameter='@rateCategories.c:Species'/>
		<operator id='CategoriesUniform.c:Species' spec='UniformOperator' weight="10" parameter='@rateCategories.c:Species'/>

		<upDownOperator id='relaxedUpDownOperator.c:Species' spec='UpDownOperator' scaleFactor="0.75" weight="3">
			<up idref="ucldMean.c:Species"/>
			<down idref="Tree.t:Species"/>
		</upDownOperator>

        <prior id='ucldStdevPrior.c:Species' x='@ucldStdev.c:Species'>

            <!-- this prior has a median of 0.1 and 97.5% of its probability is below S=1 -->
            <distr spec="beast.math.distributions.Gamma">
                <parameter name='alpha' value="0.5396" estimate='false'/> <!-- shape -->
                <parameter name='beta' value="0.3819" estimate='false'/> <!-- scale -->
            </distr>

            <!-- <distr spec="beast.math.distributions.Exponential">
                <parameter name='mean' value="0.3333" estimate='false'/>
            </distr> -->
        </prior>


		<log id='rate.c:Species' spec='RateStatistic' tree='@Tree.t:Species' branchratemodel='@RelaxedClock.c:Species'/>
        <prior id='MeanRatePrior.c:Species' x='@ucldMean.c:Species'><distr spec="beast.math.distributions.Uniform" upper='Infinity'/></prior>
]]>
            <connect srcID='ucldMean.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(ucldMean.c:Species) and ucldMean.c:Species/estimate=true'/>
            <connect srcID='ucldStdev.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(ucldStdev.c:Species) and ucldStdev.c:Species/estimate=true'/>
            <connect srcID='rateCategories.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(rateCategories.c:Species)'/>

            <connect srcID='ucldMeanScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(ucldMean.c:Species) and ucldMean.c:Species/estimate=true'>Scale clock rate of partition
                c:Species
            </connect>
            <connect srcID='ucldStdevScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(ucldStdev.c:Species) and ucldStdev.c:Species/estimate=true'>Scale stdev of rate of partition c:Species
            </connect>
            <connect srcID='CategoriesRandomWalk.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(rateCategories.c:Species) and rateCategories.c:Species/estimate=true'>Randomly change categories of partition c:Species
            </connect>
            <connect srcID='CategoriesSwapOperator.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(rateCategories.c:Species) and rateCategories.c:Species/estimate=true'>Swap categories of partition c:Species
            </connect>
            <connect srcID='CategoriesUniform.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(rateCategories.c:Species) and rateCategories.c:Species/estimate=true'>Uniformly draw categories of partition c:Species
            </connect>
            <connect srcID='relaxedUpDownOperator.c:Species' targetID='mcmc' inputName='operator'
                     if='nooperator(FixMeanRatesOperator) and inlikelihood(ucldMean.c:Species) and ucldMean.c:Species/estimate=true and Tree.t:Species/estimate=true'>
                Up/down scaler for mean rate and tree of partition c:Species
            </connect>
            <connect srcID='Tree.t:Species' targetID='RelaxedClock.c:Species' inputName='tree' if='inlikelihood(RelaxedClock.c:Species)'/>
            <connect srcID='Tree.t:Species' targetID='rate.c:Species' inputName='tree' if='inlikelihood(RelaxedClock.c:Species)'/>

            <connect srcID='ucldMean.c:Species' targetID='tracelog' inputName='log'
                     if='inlikelihood(ucldMean.c:Species) and ucldMean.c:Species/estimate=true'/>
            <connect srcID='ucldStdev.c:Species' targetID='tracelog' inputName='log' if='inlikelihood(ucldStdev.c:Species)'/>
            <connect srcID='rate.c:Species' targetID='tracelog' inputName='log' if='inposterior(RelaxedClock.c:Species)'/>

            <connect srcID='ucldStdevPrior.c:Species' targetID='prior' inputName='distribution'
                     if='inlikelihood(ucldStdev.c:Species)'>uncorrelated lognormal relaxed clock stdev of partition c:Species
            </connect>
            <connect srcID='MeanRatePrior.c:Species' targetID='prior' inputName='distribution'
                     if='inlikelihood(ucldMean.c:Species) and inlikelihood(Tree.t:Species) and ucldMean.c:Species/estimate=true'>
                uncorrelated lognormal relaxed clock mean of partition c:Species
            </connect>

            <connect srcID='RelaxedClock.c:Species' targetID='TreeWithMetaDataLogger.t:Species' inputName='branchratemodel'
                     if='inposterior(RelaxedClock.c:Species)'/>
        </subtemplate>


        <!-- Random local clock -->
        <subtemplate id='RandomLocalClock' class='beast.evolution.branchratemodel.RandomLocalClockModel'
                     mainid='RandomLocalClock.c:Species'
                     suppressInputs='beast.evolution.branchratemodel.RandomLocalClockModel.rates'>
            <![CDATA[
        <input spec='RandomLocalClockModel' id="RandomLocalClock.c:Species" ratesAreMultipliers="false" tree='@Tree.t:Species'>
            <clock.rate id='meanclockRate.c:Species' spec='parameter.RealParameter' value='1.0' estimate='false'/>
            <parameter spec='parameter.BooleanParameter' name='indicators' id='Indicators.c:Species' value="0"/>
            <parameter name='rates' id='clockrates.c:Species' value="1" lower="1e-9"/>
        </input>

        <operator id="IndicatorsBitFlip.c:Species" spec="BitFlipOperator" weight="15" parameter="@Indicators.c:Species"/>
<!-- this should probably be a DeltaExchange instead of scale operator to keep mean rate to 1 -->
        <operator id='ClockRateScaler.c:Species' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="15" parameter="@clockrates.c:Species"/>

        <operator id='randomClockScaler.c:Species' spec='ScaleOperator' scaleAll='false' scaleFactor="0.5" weight="1" parameter="@meanclockRate.c:Species"/>
		<upDownOperator id='randomClockUpDownOperator.c:Species' spec='UpDownOperator' scaleFactor="0.75" weight="3">
			<up idref="meanclockRate.c:Species"/>
			<down idref="Tree.t:Species"/>
		</upDownOperator>

		<distribution idref="prior">
			<if cond='inlikelihood(RandomLocalClock.c:Species)'>
				<!-- prior on rates -->
			    <prior id='RRatesPrior.c:sSpecies' name="distribution" x='@clockrates.c:Species'>
			        <Gamma id="Gamma.0" name="distr">
			            <parameter estimate="false" name="alpha">0.5</parameter>
			            <parameter estimate="false" name="beta">2.0</parameter>
			        </Gamma>
				</prior>

				<!-- prior on number of changes -->
				<prior id="RRateChangesPrior.c:Species" name="distribution">
					<x id="RRateChanges.c:Species" spec="beast.core.util.Sum" arg="@Indicators.c:Species"/>
                    <distr spec='beast.math.distributions.Poisson'>
                          <lambda spec='parameter.RealParameter' estimate='false' value='0.6931471805599453'/>
                    </distr>
				</prior>
			</if>
		</distribution>

		<logger idref="tracelog">
			<if cond='inlikelihood(RandomLocalClock.c:Species)'>
				<log idref="RRateChanges.c:Species"/>
			</if>
		</logger>

        <prior id='MeanRRatePrior.c:sSpecies' x='@meanclockRate.c:Species'><distr spec="beast.math.distributions.Uniform" upper='Infinity'/></prior>
]]>
            <connect srcID='Indicators.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(Indicators.c:Species)'/>
            <connect srcID='meanclockRate.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(meanClockRate.c:Species) and meanClockRate.c:Species/estimate=true'/>
            <connect srcID='clockrates.c:Species' targetID='state' inputName='stateNode'
                     if='inlikelihood(clockrates.c:Species)'/>


            <connect srcID='randomClockScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(meanClockRate.c:Species) and meanClockRate.c:Species/estimate=true'>Scale clock rate of
                partition c:Species
            </connect>
            <connect srcID='randomClockUpDownOperator.c:Species' targetID='mcmc' inputName='operator'
                     if='nooperator(FixMeanRatesOperator) and inlikelihood(meanClockRate.c:Species) and inlikelihood(Tree.t:Species) and meanClockRate.c:Species/estimate=true'>
                Up/down scaler for mean rate and tree of partition c:Species
            </connect>
            <connect srcID='IndicatorsBitFlip.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(Indicators.c:Species)'>Flip indicator bits for random clock of partition c:Species
            </connect>
            <connect srcID='ClockRateScaler.c:Species' targetID='mcmc' inputName='operator'
                     if='inlikelihood(clockrates.c:Species)'>Scale random clock rates of partition c:Species
            </connect>
            <connect srcID='Tree.t:Species' targetID='RandomLocalClock.c:Species' inputName='tree' if='inlikelihood(RandomLocalClock.c:Species)'/>

            <connect srcID='Indicators.c:Species' targetID='tracelog' inputName='log'
                     if='inlikelihood(Indicators.c:Species)'/>
            <connect srcID='clockrates.c:Species' targetID='tracelog' inputName='log'
                     if='inlikelihood(clockrates.c:Species)'/>
            <connect srcID='meanClockRate.c:Species' targetID='tracelog' inputName='log'
                     if='inposterior(RandomLocalClock.c:Species) and meanClockRate.c:Species/estimate=true'/>

            <connect srcID='MeanRRatePrior.c:Species' targetID='prior' inputName='distribution'
                     if='inlikelihood(meanClockRate.c:Species) and meanClockRate.c:Species/estimate=true'>substitution rate of
                partition c:Species
            </connect>

            <connect srcID='RandomLocalClock.c:Species' targetID='TreeWithMetaDataLogger.t:Species'
                     inputName='branchratemodel' if='inposterior(RandomLocalClock.c:Species)'/>
        </subtemplate>

    </mergewith>

</beast>


